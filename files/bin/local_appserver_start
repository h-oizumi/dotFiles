#! /bin/sh


PROGNAME=$(basename $0)

NAME_BY_BASE64='cmFrdW1vCg=='
NAME=`echo $NAME_BY_BASE64 | base64 -D`

STORAGE_PATH=$HOME/workspace/server_storage/dev-storage
WORKSPACE=$HOME/workspace/$NAME
BACKEND_YAML=$WORKSPACE/backend*.yaml
EXTRA_OPT=''
WATCHER_IGNORE="--watcher_ignore_re='(?!.*README\.md)'"

usage() {
    echo "usage: $PROGNAME [default] [hotfix] [deploy] [feature] [showmail] [sendmail] [clear_datastore]"
    echo
    echo "Options:"
    echo "  default:           use storage for default test"
    echo "  hotfix:            use workspace for hotfix"
    echo "  deploy:            use workspace for deploy"
    echo "  feature:           use workspace for feature"
    echo "  navitime:          use workspace for navitime-proxy"
    echo "  timestamp:         use workspace for timestamp"
    echo "  showmail:          use '--show_mail_body'"
    echo "  sendmail:          use '--enable_sendmail'"
    echo "  clear_datastore:   use '--clear_datastore'"
    echo
    exit 1
}

####### python 2.7 #########
for OPT in $@
do
	case $OPT in
		'def'|'default' )
			STORAGE_PATH=$HOME/workspace/server_storage/dev-storage-default
			EXTRA_OPT=$EXTRA_OPT' --automatic_restart false'
			echo 'default option'
			;;
		'hotfix' )
			WORKSPACE=$WORKSPACE"-hotfix"
            BACKEND_YAML=$WORKSPACE/backend*.yaml
			EXTRA_OPT=$EXTRA_OPT' --automatic_restart false'
			echo "use $WORKSPACE"
			;;
		'dep'|'deploy' )
			WORKSPACE=$WORKSPACE"-deploy"
            BACKEND_YAML=$WORKSPACE/backend*.yaml
			EXTRA_OPT=$EXTRA_OPT' --automatic_restart false'
			echo "use $WORKSPACE"
			;;
		'feature' )
			WORKSPACE=$WORKSPACE"-feature"
            BACKEND_YAML=$WORKSPACE/backend*.yaml
			EXTRA_OPT=$EXTRA_OPT' --automatic_restart false'
			echo "use $WORKSPACE"
			;;
		'navitime' )
			WORKSPACE=$WORKSPACE"-navitime-proxy"
            BACKEND_YAML=''
			echo "use $WORKSPACE"
			;;
		'timestamp' )
			WORKSPACE=$WORKSPACE"-timestamp"
            WATCHER_IGNORE="--watcher_ignore_re='.*/(docs|static|tools|vender|etc|bin)/.*'"
            BACKEND_YAML=''
			echo "use $WORKSPACE"
			;;
		'showmail'|'--show_mail_body' )
			EXTRA_OPT=$EXTRA_OPT' --show_mail_body'
			echo "use $EXTRA_OPT"
			;;
		'sendmail'|'--enable_sendmail' )
			EXTRA_OPT=$EXTRA_OPT' --enable_sendmail'
			echo "use $EXTRA_OPT"
			;;
		'clear_datastore'|'--clear_datastore' )
			echo 'clear datastore'
			# EXTRA_OPT=$EXTRA_OPT' --clear_datastore=true'
			# echo "use $EXTRA_OPT"
			;;
        '-h'|'--help'|'help' )
            usage
            exit 1
            ;;
		* )
            echo "$PROGNAME: $1: No such options" 1>&2
			usage
			exit 1
			;;
	esac
done

cd $HOME/workspace
pyenv version

python $GAE_PATH/dev_appserver.py \
	--host=localhost \
	--log_level=debug \
	--dev_appserver_log_level=debug \
	--storage_path=$STORAGE_PATH \
    $WATCHER_IGNORE \
	$WORKSPACE \
	$BACKEND_YAML \
	$EXTRA_OPT

